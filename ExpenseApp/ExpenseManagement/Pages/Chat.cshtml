@page
@model ChatModel
@{
    ViewData["Title"] = "AI Chat Assistant";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h1 class="h4 mb-0">
                        <i class="bi bi-robot"></i> AI Chat Assistant
                    </h1>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
                            <br /><small>The chat will respond with dummy messages until GenAI services are deployed.</small>
                        </div>
                    }

                    <div id="chat-messages" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-muted text-center py-5">
                            <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                            <p class="mt-3">Ask me anything about expenses!</p>
                            <small>Try: "Show me all submitted expenses" or "Create a new travel expense for Â£50"</small>
                        </div>
                    </div>

                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control" placeholder="Type your message..." />
                        <button id="send-btn" class="btn btn-primary">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-center">
                <a href="/Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Expenses
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const genAIAvailable = @Model.GenAIAvailable.ToString().ToLower();
    
    let conversationHistory = [
        {
            role: 'system',
            content: 'You are a helpful assistant for the Expense Management System.'
        }
    ];

    function addMessage(role, content, isDummy = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : 'text-start'}`;
        
        const badge = role === 'user' 
            ? '<span class="badge bg-primary">You</span>' 
            : isDummy 
                ? '<span class="badge bg-warning text-dark">AI (Dummy Mode)</span>'
                : '<span class="badge bg-success">AI Assistant</span>';
        
        const messageContent = `
            <div class="${role === 'user' ? 'd-inline-block text-end' : 'd-inline-block text-start'}" style="max-width: 80%;">
                ${badge}
                <div class="p-3 mt-1 rounded ${role === 'user' ? 'bg-primary text-white' : 'bg-white border'}">
                    ${content}
                </div>
            </div>
        `;
        
        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function getDummyResponse(userMessage) {
        const lowerMsg = userMessage.toLowerCase();
        
        if (lowerMsg.includes('expense') || lowerMsg.includes('show') || lowerMsg.includes('list')) {
            return "I would show you the expenses from the database, but GenAI services are not deployed yet. Please run 'deploy-with-chat.sh' to enable full AI capabilities.";
        }
        if (lowerMsg.includes('create') || lowerMsg.includes('add') || lowerMsg.includes('new')) {
            return "I would create a new expense for you, but GenAI services are not deployed yet. Please run 'deploy-with-chat.sh' to enable full AI capabilities.";
        }
        if (lowerMsg.includes('help')) {
            return "I'm an AI assistant for the Expense Management System. I can help you view, create, and manage expenses using natural language. However, I need GenAI services to be deployed to work properly. Please run 'deploy-with-chat.sh' to enable full functionality.";
        }
        
        return "I understand your message, but I need GenAI services to provide intelligent responses. Please deploy with 'deploy-with-chat.sh' to enable full AI chat capabilities.";
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessage('user', message);
        userInput.value = '';
        sendBtn.disabled = true;

        conversationHistory.push({
            role: 'user',
            content: message
        });

        if (!genAIAvailable) {
            // Dummy response
            const dummyResponse = getDummyResponse(message);
            setTimeout(() => {
                addMessage('assistant', dummyResponse, true);
                conversationHistory.push({
                    role: 'assistant',
                    content: dummyResponse
                });
                sendBtn.disabled = false;
            }, 500);
            return;
        }

        try {
            const response = await fetch('/Chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    messages: conversationHistory,
                    userMessage: message
                })
            });

            const data = await response.json();
            
            if (data.success) {
                addMessage('assistant', data.message, data.isDummyResponse || false);
                conversationHistory.push({
                    role: 'assistant',
                    content: data.message
                });
            } else {
                addMessage('assistant', data.message || 'Sorry, I encountered an error.', true);
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('assistant', 'Sorry, I encountered an error. Please try again.', true);
        } finally {
            sendBtn.disabled = false;
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Clear the welcome message on first interaction
    userInput.addEventListener('focus', function() {
        if (chatMessages.querySelector('.text-muted')) {
            chatMessages.innerHTML = '';
        }
    }, { once: true });
</script>
}
